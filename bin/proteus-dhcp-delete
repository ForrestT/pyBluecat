#!/usr/bin/python
import argparse
import json
from proteus import SOAPClient

parser = argparse.ArgumentParser()
parser.add_argument('mac_addr', help='MAC Address')
parser.add_argument('creds', help='path to file containing credentials')
parser.add_argument('-m', '--monitordeployment', action='store_true',
                    help='if set, script will follow deployment progress')
parser.add_argument('--nodeploy', action='store_true', help='Do NOT deploy saved changes')
args = parser.parse_args()

mac = args.mac_addr.replace('.', '').replace(':', '').replace('-', '')
with open(args.creds) as f:
    creds = json.load(f)

c = SOAPClient(creds['username'], creds['password'])

macEntity = c.getMACAddress(mac)
results = c.getLinkedEntities(macEntity.id)
print('deleted:')
for ipEntity in results:
    ipAddr = ipEntity['properties'].split('address=')[1].split('|')[0]
    netObj = c.getIP4Network(ipAddr)
    if not args.nodeploy:
        c.queueServers(netObj)
    c.deleteEntity(ipEntity['id'])
    print(ipEntity)
# Do NOT deploy changes if arg is set
if not args.nodeploy:
    c.deployQueuedServers()
    if args.monitordeployment:
        c.monitorServerDeployment()
else:
    print('MAC Reservation deleted, but change not deployed.')
c.logout()
