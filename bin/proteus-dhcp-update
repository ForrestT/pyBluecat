#!/usr/bin/python
import argparse
import json
from proteus import SOAPClient

parser = argparse.ArgumentParser()
parser.add_argument('hostname', help='hostname')
parser.add_argument('mac_addr', help='MAC Address')
parser.add_argument('ip_addr', help='ip_addr of Reservation to update')
parser.add_argument('creds', help='path to file containing credentials')
parser.add_argument('-m', '--monitordeployment', action='store_true',
                    help='if set, script will follow deployment progress')
parser.add_argument('--nodeploy', action='store_true', help='Do NOT deploy saved changes')
args = parser.parse_args()

with open(args.creds) as f:
    creds = json.load(f)
hostname = args.hostname
mac = args.mac_addr.replace('.', '').replace(':', '').replace('-', '')
ipAddr = args.ip_addr

c = SOAPClient(creds['username'], creds['password'])

ipObj = c.getIP4Address(ipAddr)
newObj = c.updateEntityProperties(ipObj, hostname, mac, 'DHCP_RESERVED')
response = c.updateEntity(newObj)

print('Old Reservation:')
print(json.dumps(ipObj, indent=2, sort_keys=True))
print('New Reservation:')
print(json.dumps(c.apiEntityToDict(newObj), indent=2, sort_keys=True))

# Do NOT deploy changes if arg is set
if not args.nodeploy:
    netObj = c.getIP4Network(ipAddr)
    c.queueServers(netObj)
    c.deployQueuedServers()
    if args.monitordeployment:
        c.monitorServerDeployment()
else:
    print('MAC Reservation created, but change not deployed.')
c.logout()
